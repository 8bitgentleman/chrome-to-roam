(()=>{"use strict";var t={d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{$C:()=>b,CT:()=>k,D4:()=>v,DM:()=>T,Df:()=>g,Gc:()=>m,T$:()=>y,X4:()=>p,j4:()=>f,pe:()=>w,q:()=>d});var r,n,o,i,a,c=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{s(n.next(t))}catch(t){i(t)}}function c(t){try{s(n.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,c)}s((n=n.apply(t,e||[])).next())}))},s=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r},u=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};class l{call(t){return fetch(t)}}class h{constructor(t,e,r){o.set(this,void 0),i.set(this,void 0),a.set(this,void 0),s(this,o,t,"f"),this.graph=e,s(this,a,r,"f")}api(t,e,r){var n;return c(this,void 0,void 0,(function*(){const o=this.makeRequest(t,e,r),c=yield u(this,a,"f").call(o);if(c.redirected){const t=/(https:\/\/peer-\d+.*?:\d+)\/.*/,e=c.url.match(t);2==(null==e?void 0:e.length)&&s(this,i,e[1],"f")}switch(c.status){case 200:break;case 500:case 400:throw new Error(null!==(n="Error: "+(yield c.json()).message)&&void 0!==n?n:"HTTP "+c.status);case 429:throw new Error("Too many requests, try again in a minute.");case 401:throw new Error("Invalid token or token doesn't have enough privileges.");case 503:throw new Error("HTTP Status: 503. Your graph is not ready yet for a request, please retry in a few seconds.");default:throw new Error(c.statusText)}return c}))}makeRequest(t,e="POST",a){var c;const s=null!==(c=u(this,i,"f"))&&void 0!==c?c:u(h,r,"f",n);return new Request(s+t,{method:e,mode:"cors",cache:"no-cache",body:JSON.stringify(a),headers:{"Content-Type":"application/json; charset=utf-8",Authorization:`Bearer ${u(this,o,"f")}`,"x-authorization":`Bearer ${u(this,o,"f")}`}})}}function d(t,e,r){return c(this,void 0,void 0,(function*(){const n=`/api/graph/${t.graph}/q`;let o;o=r?{query:e,args:r}:{query:e};const i=yield t.api(n,"POST",o),{result:a}=yield i.json();return a}))}function p(t,e,r){return c(this,void 0,void 0,(function*(){const n=`/api/graph/${t.graph}/pull`,o={eid:r,selector:e},i=yield t.api(n,"POST",o),{result:a}=yield i.json();return a}))}function f(t,e){return c(this,void 0,void 0,(function*(){e.action="create-block";const r=`/api/graph/${t.graph}/write`;return(yield t.api(r,"POST",e)).ok}))}function w(t,e){return c(this,void 0,void 0,(function*(){e.action="move-block";const r=`/api/graph/${t.graph}/write`;return(yield t.api(r,"POST",e)).ok}))}function g(t,e){return c(this,void 0,void 0,(function*(){e.action="update-block";const r=`/api/graph/${t.graph}/write`;return(yield t.api(r,"POST",e)).ok}))}function m(t,e){return c(this,void 0,void 0,(function*(){e.action="delete-block";const r=`/api/graph/${t.graph}/write`;return(yield t.api(r,"POST",e)).ok}))}function v(t,e){return c(this,void 0,void 0,(function*(){e.action="create-page";const r=`/api/graph/${t.graph}/write`;return(yield t.api(r,"POST",e)).ok}))}function y(t,e){return c(this,void 0,void 0,(function*(){e.action="update-page";const r=`/api/graph/${t.graph}/write`;return(yield t.api(r,"POST",e)).ok}))}function k(t,e){return c(this,void 0,void 0,(function*(){e.action="delete-page";const r=`/api/graph/${t.graph}/write`;return(yield t.api(r,"POST",e)).ok}))}function b(t,e){return c(this,void 0,void 0,(function*(){e.action="batch-actions";const r=`/api/graph/${t.graph}/write`,n=yield t.api(r,"POST",e);return yield n.json()}))}function T(t){return null==t.httpClient&&(t.httpClient=new l),new h(t.token,t.graph,t.httpClient)}r=h,o=new WeakMap,i=new WeakMap,a=new WeakMap,n={value:"https://api.roamresearch.com"};var E=e.$C,P=e.DM;async function $(t){try{const r=new Date,n=`${("0"+(r.getMonth()+1)).slice(-2)}-${("0"+r.getDate()).slice(-2)}-${r.getFullYear()}`;let o;o=t.url?{action:"batch-actions",actions:[{action:"create-block",location:{"parent-uid":n,order:"last"},block:{string:"#inbox",uid:-1}},{action:"create-block",location:{"parent-uid":-1,order:"last"},block:{string:`[${t.text}](${t.url})`,order:"last"}}]}:{action:"batch-actions",actions:[{action:"create-block",location:{"parent-uid":n,order:"last"},block:{string:"#inbox",uid:-1}},{action:"create-block",location:{"parent-uid":-1,order:"last"},block:{string:t.text,uid:-2}},{action:"create-block",location:{"parent-uid":-2,order:"last"},block:{string:`Source::${t.url}`}}]};const i=await(e=["graphName","graphEditToken"],new Promise(((t,r)=>{chrome.storage.sync.get(e,(e=>{if(chrome.runtime.lastError)return r(new Error(chrome.runtime.lastError));t(e)}))})));if(!i.graphName||!i.graphEditToken)throw alert("Both Graph Name and Graph Edit Token must be set in the extension settings."),new Error("Both Graph Name and Graph Edit Token must be set in the extension settings.");const a=P({token:i.graphEditToken,graph:i.graphName});await E(a,o),console.log("Data sent to Roam successfully")}catch(t){console.error("Error sending data to API:",t)}var e}chrome.runtime.onInstalled.addListener((function(){chrome.contextMenus.create({id:"sendToRoam",title:"Send to Roam Research",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener((async function(t,e){if("sendToRoam"===t.menuItemId){const e={text:t.selectionText,url:t.pageUrl};await $(e)}})),chrome.commands.onCommand.addListener((async function(t){if("send-page-url"===t)try{const[t]=await(e={active:!0,currentWindow:!0},new Promise(((t,r)=>{chrome.tabs.query(e,(e=>{if(chrome.runtime.lastError)return r(new Error(chrome.runtime.lastError));t(e)}))}))),r={text:t.title,url:t.url};await $(r)}catch(t){console.error("Error querying tabs:",t)}var e}))})();